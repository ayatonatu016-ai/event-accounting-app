<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>会計アプリ（売上履歴付き）</title>
<style>
#video { width: 100%; max-width: 400px; border: 2px solid #333; }
#cart, #products, #history { margin-top: 20px; border: 1px solid #aaa; padding: 10px; }
</style>
</head>
<body>
<h1>簡易会計アプリ（QR＋売上履歴）</h1>

<!-- CSV読込 -->
<input type="file" id="csvFile" accept=".csv"><br><br>

<!-- カメラ -->
<button id="startBtn">カメラ起動</button>
<video id="video" autoplay playsinline></video>
<p>読み取り結果: <span id="result">未読み取り</span></p>

<!-- カート表示 -->
<div id="cart">
  <h3>カート</h3>
  <ul id="cartItems"></ul>
  <p>合計: <span id="total">0</span> 円</p>
</div>

<!-- 商品リスト -->
<div id="products">
  <h3>商品リスト（残り在庫）</h3>
  <ul id="productList"></ul>
</div>

<!-- 売上履歴 -->
<div id="history">
  <h3>売上履歴</h3>
  <ul id="historyList"></ul>
  <button id="exportBtn">CSVエクスポート</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
let products = {}; // 商品データ {ID: {name, price, stock}}
let cart = [];
let total = 0;
let salesHistory = []; // 売上履歴 [{time, id, name, price}]

const video = document.getElementById("video");
const resultSpan = document.getElementById("result");
const cartItems = document.getElementById("cartItems");
const totalSpan = document.getElementById("total");
const productList = document.getElementById("productList");
const historyList = document.getElementById("historyList");

// CSVファイル読込
document.getElementById("csvFile").addEventListener("change", function(evt){
  const file = evt.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const lines = e.target.result.split("\n").map(l => l.trim()).filter(l => l);
    products = {};
    for(let line of lines){
      const [id, name, price, stock] = line.split(",");
      products[id] = { name, price: parseInt(price), stock: parseInt(stock) };
    }
    alert("商品データ読み込み完了: " + Object.keys(products).length + "件");
    updateProductList();
  };
  reader.readAsText(file);
});

// 商品リスト表示
function updateProductList(){
  productList.innerHTML = "";
  for(const id in products){
    const item = products[id];
    const li = document.createElement("li");
    li.textContent = `${item.name} - ${item.price}円 / 残り${item.stock}`;
    productList.appendChild(li);
  }
}

// カメラ起動
document.getElementById("startBtn").onclick = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    scanQR();
  } catch (err) {
    alert("カメラ起動失敗: " + err.message);
  }
};

// QR読み取り
function scanQR(){
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  function tick(){
    if(video.readyState === video.HAVE_ENOUGH_DATA){
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);
      if(code){
        handleQR(code.data);
      }
    }
    requestAnimationFrame(tick);
  }
  tick();
}

// QRを商品として処理
function handleQR(id){
  if(products[id]){
    if(products[id].stock > 0){
      products[id].stock -= 1; // 在庫を減らす
      cart.push(products[id]);
      total += products[id].price;

      const time = new Date().toLocaleString();
      salesHistory.push({ time, id, name: products[id].name, price: products[id].price });

      resultSpan.textContent = `追加: ${products[id].name} (${products[id].price}円)`;
      updateCart();
      updateProductList();
      updateHistory();
    } else {
      resultSpan.textContent = `${products[id].name} は在庫切れです`;
    }
  } else {
    resultSpan.textContent = `不明な商品ID: ${id}`;
  }
}

// カート更新表示
function updateCart(){
  cartItems.innerHTML = "";
  cart.forEach(item => {
    const li = document.createElement("li");
    li.textContent = `${item.name} - ${item.price}円`;
    cartItems.appendChild(li);
  });
  totalSpan.textContent = total;
}

// 履歴更新表示
function updateHistory(){
  historyList.innerHTML = "";
  salesHistory.forEach(sale => {
    const li = document.createElement("li");
    li.textContent = `${sale.time} - ${sale.name} (${sale.price}円)`;
    historyList.appendChild(li);
  });
}

// CSVエクスポート
document.getElementById("exportBtn").onclick = () => {
  let csv = "日時,ID,商品名,価格\n";
  salesHistory.forEach(sale => {
    csv += `${sale.time},${sale.id},${sale.name},${sale.price}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "sales_history.csv";
  a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>




