<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>イベント会計アプリ ver5.1</title>
<style>
body { font-family: sans-serif; margin: 20px; }
h1 { font-size: 20px; }
#status { padding: 5px; margin: 5px 0; font-weight: bold; }
#status.ok { color: green; }
#status.err { color: red; }
#cart { margin-top: 10px; border: 1px solid #ccc; padding: 10px; }
button { margin: 5px; padding: 8px 12px; }
#barcodeInput { width: 250px; padding: 5px; font-size: 16px; }
</style>
</head>
<body>
<h1>イベント会計アプリ ver5.1</h1>
<p>商品CSVを読み込み → バーコードリーダーでスキャン（CRで確定）</p>

<!-- CSVファイル読み込み -->
<input type="file" id="csvFile" accept=".csv">
<div id="status">商品データ未読込</div>

<!-- バーコード入力欄（Bluetoothリーダー入力用） -->
<input type="text" id="barcodeInput" placeholder="ここにバーコード入力" autofocus>
<p>読み取り結果: <span id="lastScan">未読み取り</span></p>

<hr>
<h3>カート</h3>
<ul id="cartList"></ul>
<p>合計: <span id="total">0</span> 円</p>

<!-- 受け取り金額ボタン -->
<h3>受け取り金額</h3>
<div id="payButtons">
  <button onclick="addPayment(100)">100円</button>
  <button onclick="addPayment(500)">500円</button>
  <button onclick="addPayment(1000)">1000円</button>
  <button onclick="addPayment(5000)">5000円</button>
  <button onclick="addPayment(10000)">10000円</button>
</div>
<p>受取合計: <span id="paid">0</span> 円</p>
<p>お釣り: <span id="change">0</span> 円</p>

<button onclick="checkout()">会計確定</button>
<button onclick="clearCart()">カートクリア</button>
<button id="exportBtn">売上履歴CSV出力</button>

<hr>
<h3>売上履歴</h3>
<ul id="historyList"></ul>

<footer style="margin-top:20px;font-size:12px;color:gray;">
Ver5.1 (2025-10-04)<br>
・商品CSV読み込み機能復活<br>
・Bluetoothバーコードリーダー（CRのみ）対応<br>
・一致した商品を自動カート追加<br>
・入力値は常に半角変換処理<br>
</footer>

<script>
// 商品データ
let products = {};   // {ID: {name, price}}
let cart = [];
let total = 0;
let paid = 0;
let salesHistory = [];

// 全角→半角変換
function toHalfWidth(str){
  return str.replace(/[！-～]/g, ch =>
    String.fromCharCode(ch.charCodeAt(0)-0xFEE0)
  ).replace(/　/g," ");
}

// CSV読み込み
document.getElementById("csvFile").addEventListener("change", function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(){
    const lines = reader.result.split(/\r?\n/).filter(l=>l.trim());
    products = {};
    for(let i=1;i<lines.length;i++){ // 1行目ヘッダ想定
      const [id,name,price] = lines[i].split(",");
      if(id && name && price){
        products[toHalfWidth(id.trim())] = {name:name.trim(), price:parseInt(price)};
      }
    }
    document.getElementById("status").textContent = "商品データ読込完了";
    document.getElementById("status").className = "ok";
  };
  reader.readAsText(file,"UTF-8");
});

// バーコード入力処理
const barcodeInput = document.getElementById("barcodeInput");
barcodeInput.addEventListener("keydown", (e)=>{
  if(e.key === "Enter" || e.keyCode === 13){ // CR/Enter検出
    const code = toHalfWidth(barcodeInput.value.trim());
    barcodeInput.value = "";
    if(!code) return;
    if(products[code]){
      addToCart(code);
      showMsg(`追加: ${products[code].name} (${products[code].price}円)`, false);
      if(navigator.vibrate) navigator.vibrate(150);
    } else {
      showMsg(`不明な商品ID: ${code}`, true);
      if(navigator.vibrate) navigator.vibrate([100,50,100]);
    }
  }
});

// カート追加
function addToCart(code){
  cart.push(products[code]);
  total += products[code].price;
  updateCart();
}

// カート更新
function updateCart(){
  const list=document.getElementById("cartList");
  list.innerHTML="";
  cart.forEach(item=>{
    const li=document.createElement("li");
    li.textContent=`${item.name} - ${item.price}円`;
    list.appendChild(li);
  });
  document.getElementById("total").textContent=total;
  updateChange();
}

// メッセージ表示
function showMsg(msg,isErr){
  const el=document.getElementById("lastScan");
  el.textContent=msg;
  el.style.color=isErr?"red":"green";
}

// 支払い
function addPayment(val){
  paid += val;
  document.getElementById("paid").textContent=paid;
  updateChange();
}
function updateChange(){
  document.getElementById("change").textContent=paid-total;
}

// 会計確定
function checkout(){
  if(cart.length===0) return;
  salesHistory.push({
    time:new Date().toLocaleString(),
    items:cart.map(c=>c.name),
    sum:total
  });
  renderHistory();
  clearCart();
}

// カートクリア
function clearCart(){
  cart=[]; total=0; paid=0;
  updateCart();
  document.getElementById("paid").textContent=0;
  document.getElementById("change").textContent=0;
}

// 履歴表示
function renderHistory(){
  const list=document.getElementById("historyList");
  list.innerHTML="";
  salesHistory.forEach(sale=>{
    const li=document.createElement("li");
    li.textContent=`${sale.time} - ${sale.items.join(" / ")} : ${sale.sum}円`;
    list.appendChild(li);
  });
}

// CSV出力
document.getElementById("exportBtn").onclick=()=>{
  let csv="日時,商品リスト,合計金額\n";
  salesHistory.forEach(sale=>{
    csv+=`${sale.time},"${sale.items.join(" / ")}",${sale.sum}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="sales_history.csv"; a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
